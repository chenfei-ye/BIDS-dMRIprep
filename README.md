

# BIDS-dMRIprep

`BIDS-dmriprep` is developed to perform dwi preprocessing based on [MRtrix3](https://www.mrtrix.org/). Main functions include:
- dMRI denoise (*dwidenoise*)
- Remove Gibbs Ringing Artifacts (*mrdegibbs*)
- fieldmap-less susceptibility distortion (*ANTs-SyN*)
- topup and eddy correction (*dwifslpreproc*)
- brain masking (*dwi2mask*)
- downsample to 2mm (*mrgrid*)
- transform dMRI to the T1 native space (*antsApplyTransforms*)
- linear transform dMRI to MNI space (*antsRegistrationSyNQuick*)

The input data should be arranged according to [BIDS format](https://bids.neuroimaging.io/). Input image modalities must include 3D-T1w and dMRI data. 


[BIDS-dMRIprep 中文说明](resources/README_Chs.md)

Check bids-dmriprep version history in [Change Log](resources/CHANGELOG.md)

## Contents
* [Install](#Install)
* [Before Running](#before-running)
* [Running](#running)
* [Input Argument](#input-argument)
* [Output Explanation](#output-explanation)

## Install
### install by pulling (recommend)
```
docker pull mindsgo-sz-docker.pkg.coding.net/neuroimage_analysis/base/bids-dmriprep:latest
docker tag  mindsgo-sz-docker.pkg.coding.net/neuroimage_analysis/base/bids-dmriprep:latest  bids-dmriprep:latest
```

### or install by docker build
```
cd BIDS-dmriprep
docker build -t bids-dmriprep:latest .
```
## Before Running
use [sMRIPrep](https://github.com/chenfei-ye/BIDS-sMRIprep) for T1w data preprocessing
```
docker run -it --rm -v <bids_root>:/bids_dataset bids-smriprep:latest python /run.py /bids_dataset --participant_label 01 02 03 -MNInormalization -fsl_5ttgen -cleanup
```

## Running
### default running using GPU (eddy_cuda)
```
docker run -it --rm --gpus all -v <bids_root>:/bids_dataset bids-dmriprep:latest python /run.py /bids_dataset /bids_dataset/derivatives/dmri_prep participant -mode complete
```

### running using CPU (eddy_openmp)
```
docker run -it --rm -v <bids_root>:/bids_dataset bids-dmriprep:latest python /run.py /bids_dataset /bids_dataset/derivatives/dmri_prep participant -mode complete
```

## Input Argument
####   positional argument:
-   `/bids_dataset`: The root folder of a BIDS valid dataset (sub-XX folders should be found at the top level in this folder).
-   `/bids_dataset/derivatives/dmri_prep`: output path
- `participant`: process on participant level

####   optional argument:
-   `--participant_label [str]`：A space delimited list of participant identifiers or a single identifier (the sub- prefix can be removed)
-   `--session_label [str]`：A space delimited list of session identifiers or a single identifier (the ses- prefix can be removed)
- `-mode ["fast", "complete"]`：complete mode (default) includes eddy current distortion correction. fast mode will jump eddy process. 
- `-resume`：resume running based on the temporary output generated by last run. 
- `-v`：check version 
- `-cleanup`: remove temporary files.


## Output explanation

- log: `<local_bids_dir>/derivatives/dmri_prep/runtime.log`
- DWI in native space: `<local_bids_dir>/derivatives/dmri_prep/sub-XX/dwi.nii.gz`
- DWI in MNI space: `<local_bids_dir>/derivatives/dmri_prep/sub-XX/dwi_mni.nii.gz`
- Transform affine matrix from dwi to T1 space (ANTs): `<local_bids_dir>/derivatives/dmri_prep/sub-XX/dwi_t1_ants.mat`
- Transform affine matrix from dwi to MNI space (ANTs): `<local_bids_dir>/derivatives/dmri_prep/sub-XX/dwi_mni_ants.mat`
- Transform affine matrix from dwi to MNI space (FSL): `<local_bids_dir>/derivatives/dmri_prep/sub-XX/dwi_mni_fsl.mat`


## Copyright
Copyright © chenfei.ye@foxmail.com
Please make sure that your usage of this code is in compliance with the code license.


